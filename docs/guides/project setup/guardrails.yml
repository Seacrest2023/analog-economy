name: guardrails-enforced

on:
  pull_request:
  push:
    branches: [main]
    paths:
      - "extension/src/**"
      - "extension/tests/**"
      - "extension/scripts/**"
      - "service/**"
      - ".github/workflows/guardrails.yml"

permissions:
  contents: read
  pull-requests: read

# IT-01.3a: CI Performance Optimizations
# - Added docs-only fast path
# - Added pip dependency caching
# - Optimized npm ci with --prefer-offline --no-audit --fund=false

jobs:
  # Fast path: Skip heavy checks for docs-only PRs
  docs-check:
    name: Check for Docs-Only Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      docs_only: ${{ steps.filter.outputs.docs_only }}
    steps:
      - uses: actions/checkout@v4
      # FIX: Issue #1073 - predicate-quantifier: 'every' ensures ALL files must match
      # for docs_only=true, not just ANY file. Without this, a PR with both docs and
      # code files would incorrectly return docs_only=true, skipping guardrails.
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          predicate-quantifier: "every"
          filters: |
            docs_only:
              - '**/*.md'
              - 'docs/**'

  # Issue #1251: Static Governance (Fail Fast) - No npm ci needed
  # Runs BEFORE heavy jobs to give feedback in <30 seconds
  static-checks:
    name: Static Governance (Fail Fast)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Issue #1251: Iron Dome Layer 3 - eslint-disable Gate (No npm ci)
      # This check runs WITHOUT npm ci for instant feedback (<30s)
      - name: "Iron Dome: eslint-disable Gate (No npm ci)"
        working-directory: extension
        env:
          CI: "true"
          GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: node scripts/governance/check-eslint-disable.js

      # Issue #1249: Integration Test Pairing (Buddy System)
      # Every user-facing feature MUST have a corresponding integration test
      - name: "Iron Dome: Integration Test Pairing (No npm ci)"
        working-directory: extension
        run: node scripts/governance/verify-integration-pairing.js

      # Issue #1290: Iron Dome Gap #17 - Security-Critical Gate
      # Prevents AI from silently modifying authentication/authorization code
      - name: "Iron Dome: Security-Critical Gate (No npm ci)"
        working-directory: extension
        env:
          CI: "true"
          GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: node scripts/governance/check-security-critical.js

      # Issue #1282: Iron Dome Gap #9 - Circular Dependency Detection
      # AI creates tangled import graphs that cause runtime issues
      - name: "Iron Dome: Circular Dependency Gate"
        working-directory: extension
        run: node scripts/governance/check-circular-deps.js

      # Issue #1281: Iron Dome Gap #8 - Duplicate Code Detection
      # AI copy-pastes code instead of refactoring, creating maintenance debt
      - name: "Iron Dome: Duplicate Code Gate"
        working-directory: extension
        run: node scripts/governance/check-duplicate-code.js

      # Issue #1389: Supply Chain Security - AI Hallucination Detector
      # CRITICAL: Runs BEFORE npm ci to prevent postinstall script execution
      # Detects non-existent packages, very new packages (< 30 days), typosquats
      - name: "Iron Dome: Hallucination Detector (No npm ci)"
        working-directory: extension
        run: node scripts/governance/check-hallucinations.js

  # Issue #1288: Iron Dome Gap #15 - Secret Detection (CI Gate)
  # Catches secrets that bypass pre-commit hooks (via --no-verify)
  # Uses gitleaks CLI directly (no license required for open source)
  secret-detection:
    name: Secret Detection (Iron Dome Gap #15)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install gitleaks CLI directly (avoids license requirement of gitleaks-action@v2)
      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.21.2/gitleaks_8.21.2_linux_x64.tar.gz | tar -xz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      # Scan for secrets in the PR diff (incremental scan)
      - name: "Iron Dome: Secret Detection (gitleaks)"
        run: |
          echo "üîç Scanning for secrets in PR changes..."
          gitleaks detect --source . --log-opts="origin/main..HEAD" --verbose
          echo "‚úÖ No secrets detected"

  # Issue #1289: Iron Dome Gap #16 - Supply Chain Security
  # Prevents AI-hallucinated packages from entering the codebase
  # Three layers: 1) Flag package.json changes, 2) Audit dependencies, 3) npm ci integrity
  supply-chain-security:
    name: Supply Chain Security (Iron Dome Gap #16)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Layer 1: Detect package.json changes and flag for human review
      - name: "Iron Dome: Package Change Detection"
        id: package-changes
        run: |
          echo "üîç Checking for package.json changes..."

          # Get list of changed files in PR
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)

          # Check for package.json changes (extension or root)
          PACKAGE_CHANGED=false
          if echo "$CHANGED_FILES" | grep -qE '^(extension/)?package\.json$'; then
            PACKAGE_CHANGED=true
            echo "‚ö†Ô∏è package.json was modified in this PR"
            echo ""
            echo "üì¶ Changed package files:"
            echo "$CHANGED_FILES" | grep -E '^(extension/)?package\.json$' || true
            echo ""
            echo "üîê Supply Chain Security Notice:"
            echo "   ‚Ä¢ New package additions require human review"
            echo "   ‚Ä¢ AI coders may hallucinate non-existent packages"
            echo "   ‚Ä¢ Verify packages exist on npm before approving"
            echo ""
          fi

          # Check for lockfile changes
          LOCKFILE_CHANGED=false
          if echo "$CHANGED_FILES" | grep -qE '^(extension/)?package-lock\.json$'; then
            LOCKFILE_CHANGED=true
            echo "üìã package-lock.json was also modified (expected with package.json changes)"
          fi

          echo "package_changed=$PACKAGE_CHANGED" >> $GITHUB_OUTPUT
          echo "lockfile_changed=$LOCKFILE_CHANGED" >> $GITHUB_OUTPUT

          if [ "$PACKAGE_CHANGED" = "true" ]; then
            echo ""
            echo "‚úÖ Package changes detected - this PR will be flagged for review"
          else
            echo "‚úÖ No package.json changes detected"
          fi

      # Layer 2: Setup Node and run npm audit
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: extension/package-lock.json

      # Layer 3: npm audit for known vulnerabilities
      - name: "Iron Dome: Dependency Audit (extension)"
        working-directory: extension
        run: |
          echo "üîç Running npm audit for known vulnerabilities..."
          echo ""

          # Run audit and capture exit code
          # --audit-level=high means only high and critical vulnerabilities fail the build
          set +e
          npm audit --audit-level=high 2>&1
          AUDIT_EXIT=$?
          set -e

          if [ $AUDIT_EXIT -ne 0 ]; then
            echo ""
            echo "‚ùå SECURITY ALERT: High or critical vulnerabilities detected!"
            echo ""
            echo "üìñ To fix:"
            echo "   1. Run 'npm audit fix' to auto-fix compatible updates"
            echo "   2. Run 'npm audit' to see full report"
            echo "   3. For breaking changes, run 'npm audit fix --force' (with caution)"
            echo ""
            exit 1
          fi

          echo ""
          echo "‚úÖ No high or critical vulnerabilities detected"

  guardrails:
    name: Size & Complexity Guardrails (enforced)
    needs: [docs-check]
    if: always() && (github.event_name != 'pull_request' || needs.docs-check.outputs.docs_only != 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies (extension)
        working-directory: extension
        run: npm ci --prefer-offline --no-audit --fund=false

      - name: Compute changed files (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} || git fetch origin
          echo "CHANGED_FILE_LIST<<EOF" >> $GITHUB_ENV
          if git merge-base origin/${{ github.event.pull_request.base.ref }} HEAD >/dev/null 2>&1; then
            git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | tr -d '\r' >> $GITHUB_ENV
          else
            git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD | tr -d '\r' >> $GITHUB_ENV || true
          fi
          echo "EOF" >> $GITHUB_ENV

      - name: Run guardrails check (extension)
        working-directory: extension
        env:
          GUARDRAILS_ENFORCE: "true"
          ONLY_CHANGED: ${{ github.event_name == 'pull_request' }}
          SRP_JSON_PATH: srp-metrics.json
        run: node scripts/ci/guardrails-check.js --enforce --json

      # NOTE: eslint-disable Gate moved to static-checks job (Issue #1251)
      # for faster feedback without waiting for npm ci

      - name: Upload SRP metrics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: srp-metrics
          path: extension/srp-metrics.json

      - name: Verify no orphan extension directories
        working-directory: extension
        run: node scripts/ci/verify-no-orphan-extension.js

      - name: "Code Health: Orphans (files/functions) & Duplicates"
        working-directory: extension
        env:
          ONLY_CHANGED: ${{ github.event_name == 'pull_request' }}
          ORPHAN_JSON_PATH: orphan-report.json
          DUP_OUT_JSON_PATH: duplication-report.json
          CODE_HEALTH_JSON_PATH: code-health.json
        run: node scripts/ci/code-health-check.js

      - name: Upload Code Health artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-health
          path: |
            extension/code-health.json
            extension/orphan-report.json
            extension/duplication-report.json

  tech-debt-scan:
    name: Tech Debt & Security (extension)
    needs: [docs-check]
    if: always() && (github.event_name != 'pull_request' || needs.docs-check.outputs.docs_only != 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies (extension)
        working-directory: extension
        run: npm ci --prefer-offline --no-audit --fund=false

      - name: Run tech-debt scanner (blocking for security)
        working-directory: extension
        run: npm run qa:tech-debt-scan

  python-tech-debt:
    name: Tech Debt & Security (service)
    needs: [docs-check]
    if: always() && (github.event_name != 'pull_request' || needs.docs-check.outputs.docs_only != 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: service/requirements.txt

      - name: Install service dependencies
        working-directory: service
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pip-audit==2.9.0

      - name: Run pip-audit on service requirements
        working-directory: service
        run: |
          python -m pip_audit -r requirements.txt --strict

      - name: Fetch base branch (for orphan check)
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          BASE_REF=${{ github.event.pull_request.base.ref || 'main' }}
          git fetch origin "$BASE_REF" || git fetch origin

      - name: Orphan module check (service)
        working-directory: service
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
        run: |
          python scripts/ci/orphan_check.py --changed-files

  python-branch-gaps:
    name: Python Branch Coverage Gaps (non-blocking)
    needs: [docs-check]
    if: always() && (github.event_name != 'pull_request' || needs.docs-check.outputs.docs_only != 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: service/requirements.txt

      - name: Install service dependencies
        working-directory: service
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run tests with coverage
        working-directory: service
        run: python -m pytest --cov=app --cov-report=json --cov-branch
        continue-on-error: true

      - name: Generate branch gaps report
        working-directory: service
        run: python scripts/ci/branch_gaps_report.py --coverage-json coverage.json --output branch-gaps-report.txt
        continue-on-error: true

      - name: Upload branch gaps report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-branch-gaps-report
          path: service/branch-gaps-report.txt

  branch-gaps-report:
    name: Branch Gaps Report (warnings only)
    needs: [docs-check]
    if: always() && (github.event_name != 'pull_request' || needs.docs-check.outputs.docs_only != 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies (extension)
        working-directory: extension
        run: npm ci --prefer-offline --no-audit --fund=false

      - name: Compute changed files under extension/src
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF=${{ github.base_ref }}
          if [[ -z "${BASE_REF}" ]]; then
            BASE_REF=main
          fi
          git fetch origin "$BASE_REF" || git fetch origin || true
          if git merge-base "origin/${BASE_REF}" "${{ github.sha }}" >/dev/null 2>&1; then
            git diff --name-only "origin/${BASE_REF}...${{ github.sha }}" | sed -n 's#^extension/##p' > changed.txt || true
          else
            git diff --name-only "origin/${BASE_REF}" "${{ github.sha }}" | sed -n 's#^extension/##p' > changed.txt || true
          fi
          echo "Changed files:"; cat changed.txt || true
          {
            echo 'changed<<EOF'
            cat changed.txt
            echo EOF
          } >> "$GITHUB_OUTPUT"

      # TIA: Only run Jest if extension source files changed (Issue #1165)
      - name: Check for extension source changes
        id: extension-check
        shell: bash
        run: |
          # Check if any extension source/test/config files changed
          if grep -qE '^src/|^tests/|^package\.json|^package-lock\.json|^jest\.config\.ts|^tsconfig\.json' changed.txt 2>/dev/null; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Extension source files changed - will run Jest coverage"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No extension source files changed - skipping Jest coverage"
          fi

      # Gatekeeper Protocol v2.0: Process Isolation
      # Removed --runInBand to enable parallel test execution in isolated workers.
      # This prevents test contamination (Heisenbugs) from shared module cache.
      - name: Run full coverage (json + json-summary)
        if: steps.extension-check.outputs.skip != 'true'
        working-directory: extension
        run: npx jest -c jest.config.ts --coverage --coverageReporters=json json-summary
        continue-on-error: true

      - name: Report uncovered branch paths (warnings only)
        if: always() && steps.extension-check.outputs.skip != 'true'
        working-directory: extension
        env:
          CHANGED: ${{ steps.changed.outputs.changed }}
          FAIL_ON_CRITICAL: "false"
        run: node scripts/coverage/report-branch-gaps.mjs

      - name: Skip notice (no extension changes)
        if: steps.extension-check.outputs.skip == 'true'
        run: |
          echo "‚è≠Ô∏è Branch Gaps Report skipped - no extension source files changed"
          echo "Changed files (from changed.txt):"
          cat changed.txt || echo "(empty)"

  python-srp-guardrails:
    name: Python SRP Size Guardrails (service)
    needs: [docs-check]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.docs-check.outputs.docs_only != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: service/requirements.txt

      - name: Compute changed Python files under service/
        id: changed_python
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF=${{ github.base_ref }}
          if [[ -z "${BASE_REF}" ]]; then
            BASE_REF=main
          fi
          git fetch origin "$BASE_REF" || git fetch origin || true
          if git merge-base "origin/${BASE_REF}" "${{ github.sha }}" >/dev/null 2>&1; then
            git diff --name-only "origin/${BASE_REF}...${{ github.sha }}" | sed -n 's#^service/##p' | grep '\.py$' > changed-python.txt || true
          else
            git diff --name-only "origin/${BASE_REF}" "${{ github.sha }}" | sed -n 's#^service/##p' | grep '\.py$' > changed-python.txt || true
          fi
          echo "Changed Python files under service/:"; cat changed-python.txt || true
          {
            echo 'changed<<EOF'
            cat changed-python.txt
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Run SRP check on changed Python files
        if: steps.changed_python.outputs.changed != ''
        working-directory: service
        shell: bash
        run: |
          set -euo pipefail
          CHANGED="${{ steps.changed_python.outputs.changed }}"
          echo "Running SRP check on:"
          echo "${CHANGED}"
          python scripts/ci/srp_check.py ${CHANGED}

      - name: Skip SRP check (no changed Python files)
        if: steps.changed_python.outputs.changed == ''
        run: echo "No changed Python files under service/; skipping SRP check."

  python-duplication-guardrails:
    name: Python Duplicate Code Guardrails (service)
    needs: [docs-check]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.docs-check.outputs.docs_only != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: service/requirements.txt

      - name: Fetch base branch
        shell: bash
        run: |
          BASE_REF=${{ github.event.pull_request.base.ref || 'main' }}
          git fetch origin "$BASE_REF" || git fetch origin

      - name: Duplicate code check (service, rising-tide)
        working-directory: service
        shell: bash
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
        run: |
          set -euo pipefail
          python scripts/ci/duplication_check.py --changed-files | tee python-duplication-report.txt

      - name: Upload Python duplication report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-duplication-report
          path: service/python-duplication-report.txt

  # Gatekeeper Protocol v2.0 Phase 2: Mutation Testing
  # Verifies that tests actually catch bugs by introducing mutations
  # and checking if tests fail. Uses Amnesty Protocol for legacy code.
  mutation-testing:
    name: Mutation Testing (StrykerJS)
    needs: [docs-check]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.docs-check.outputs.docs_only != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies (extension)
        working-directory: extension
        run: npm ci --prefer-offline --no-audit --fund=false

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} || git fetch origin

      - name: Run incremental mutation testing
        working-directory: extension
        env:
          CI: "true"
          GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: node scripts/governance/check-mutation-score.js
        # BLOCKING: Mutation score < 70% will fail the PR (Gatekeeper Protocol v2.0)
        # Amnesty requires HITL (Human In The Loop) approval - AI cannot self-exempt

      - name: Upload mutation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: extension/.stryker-tmp/

  # ============================================================================
  # GOVERNANCE TAX METRICS
  # Phase 3: Collect and report metrics for each PR
  # ============================================================================
  governance-metrics:
    name: Governance Tax Metrics
    needs: [docs-check, guardrails, tech-debt-scan]
    if: always() && github.event_name == 'pull_request' && needs.docs-check.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Record workflow start time
        id: timing
        run: |
          echo "workflow_start=${{ github.event.pull_request.updated_at || github.event.head_commit.timestamp }}" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies (extension)
        working-directory: extension
        run: npm ci --prefer-offline --no-audit --fund=false

      - name: Calculate CI timing
        id: ci-timing
        run: |
          # Calculate approximate CI time based on workflow run
          # This runs after all the main jobs, so we can estimate total time
          START_TIME=$(date -d "${{ github.event.pull_request.updated_at || github.event.head_commit.timestamp }}" +%s 2>/dev/null || echo "0")
          NOW=$(date +%s)
          if [ "$START_TIME" != "0" ]; then
            ELAPSED_SECONDS=$((NOW - START_TIME))
            ELAPSED_MINUTES=$(echo "scale=2; $ELAPSED_SECONDS / 60" | bc)
            echo "total_ci_time=$ELAPSED_MINUTES" >> $GITHUB_OUTPUT
          else
            echo "total_ci_time=0" >> $GITHUB_OUTPUT
          fi

      - name: Collect metrics
        working-directory: extension
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_SHA: ${{ github.sha }}
          CI_TOTAL_TIME: ${{ steps.ci-timing.outputs.total_ci_time }}
        run: node scripts/governance/collect-metrics.js

      - name: Generate report
        working-directory: extension
        run: node scripts/governance/report-metrics.js

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: governance-metrics
          path: extension/.metrics/
